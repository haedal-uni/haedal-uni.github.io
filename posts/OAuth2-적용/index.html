<!DOCTYPE html><html lang="ko" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Oauth2 적용" /><meta property="og:locale" content="ko" /><meta name="description" content="OAuth2 stomp를 활용하면 header에 token값을 넣어 인증을 할 수 있다는 글을 많이 보았다." /><meta property="og:description" content="OAuth2 stomp를 활용하면 header에 token값을 넣어 인증을 할 수 있다는 글을 많이 보았다." /><link rel="canonical" href="https://haedal-uni.github.io//posts/OAuth2-%EC%A0%81%EC%9A%A9/" /><meta property="og:url" content="https://haedal-uni.github.io//posts/OAuth2-%EC%A0%81%EC%9A%A9/" /><meta property="og:site_name" content="Dal Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-06T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Oauth2 적용" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-02-08T22:08:16+09:00","datePublished":"2023-03-06T00:00:00+09:00","description":"OAuth2 stomp를 활용하면 header에 token값을 넣어 인증을 할 수 있다는 글을 많이 보았다.","headline":"Oauth2 적용","mainEntityOfPage":{"@type":"WebPage","@id":"https://haedal-uni.github.io//posts/OAuth2-%EC%A0%81%EC%9A%A9/"},"url":"https://haedal-uni.github.io//posts/OAuth2-%EC%A0%81%EC%9A%A9/"}</script><title>Oauth2 적용 | Dal Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Dal Blog"><meta name="application-name" content="Dal Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://raw.githubusercontent.com/cotes2020/chirpy-images/main/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Dal Blog</a></div><div class="site-subtitle font-italic">한 걸음씩</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/haedal-uni" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Oauth2 적용</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4 pb-5"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Oauth2 적용</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1678028400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 6, 2023 </em> </span> <span> Updated <em class="" data-ts="1707397696" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 8, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/haedal-uni">haedal-uni</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6460 words"> <em>35 min</em> read</span></div></div></div><div class="post-content"><h1 id="oauth2">OAuth2</h1><p>stomp를 활용하면 header에 token값을 넣어 인증을 할 수 있다는 글을 많이 보았다.</p><p>실제로 적용하는 곳은 많지 않았는데 해당 기능을 적용할 수 있으니 한번 해봐야하지 않을까? 싶었다.</p><p>그러려면 security를 적용해야했고 기존 project에는 이미 security가 적용되어있어</p><p>다른 방법으로 로그인을 구현해봐야겠다 싶어서 OAuth를 활용했다.</p><p>*Authentication : 인증, Authorization : 인가</p><p><br /></p><p><a href="https://docs.spring.io/spring-security/reference/servlet/oauth2/login/advanced.html">공식 문서</a></p><p><br /><br /></p><h2 id="oauth2란"><span class="mr-2">OAuth2란</span><a href="#oauth2란" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://haedal-uni.github.io/posts/OAuth2/">OAuth 정리 글</a></p><p><br /><br /></p><h3 id="security-flow"><span class="mr-2">Security flow</span><a href="#security-flow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>스프링 시큐리티에서 동작하는 기본적인 formLogin을 할 경우(별도 설정x)</p><p><img data-src="https://user-images.githubusercontent.com/74857364/221817070-d5b1fd5d-4f97-41df-91cb-7ec31afa9e3f.png" alt="image" data-proofer-ignore></p><ul><li><p>client로 부터 요청을 받으면 servlet filter에서 SecurityFilterChain으로 작업이 위임되고 <br /> 그 중 UsernamePasswordAuthenticationFilter(<code class="language-plaintext highlighter-rouge">AuthenticationFilter</code>에 해당)에서 인증을 처리</p><p><code class="language-plaintext highlighter-rouge">AuthenticationFilter</code>가 요청을 가로채서 해당 정보를 통해 <code class="language-plaintext highlighter-rouge">UsernamePasswordAuthenticationToken</code> 객체 <br /> (사용자가 입력한 데이터를 기반으로 생성, 즉 현 상태는 미검증 Authentication) 생성</p><li><p><code class="language-plaintext highlighter-rouge">AuthenticationFilter</code>는 요청 객체(HttpServletRequest)에서 username과 password를 추출해서 token을 생성</p><li><p><code class="language-plaintext highlighter-rouge">AuthenticationManger</code>에게 token을 전달. <br /> <code class="language-plaintext highlighter-rouge">AuthenticationManager</code>는 인터페이스이며, 일반적으로 사용되는 구현체는 <code class="language-plaintext highlighter-rouge">ProviderManager</code>다.</p><li><p><code class="language-plaintext highlighter-rouge">ProviderManager</code>는 인증을 위해 <code class="language-plaintext highlighter-rouge">AuthenticationProvider</code>로 token을 전달한다. <br /> (UsernamePasswordAuthenticationToken 객체를 전달)</p><li><p><code class="language-plaintext highlighter-rouge">AuthenticationProvider</code>는 token의 정보를 <code class="language-plaintext highlighter-rouge">UserDetailsService</code>에 전달한다.</p><li><p><code class="language-plaintext highlighter-rouge">UserDetailsService</code>는 전달받은 정보를 통해 db에서 일치하는 사용자를 찾아 <code class="language-plaintext highlighter-rouge">UserDetails</code> 객체를 생성한다.</p><li><p>생성된 <code class="language-plaintext highlighter-rouge">UserDetails</code> 객체는 <code class="language-plaintext highlighter-rouge">AuthenticationProvider</code>로 전달되며, 해당 Provider에서 인증을 수행하고 <br /> 성공하게 되면 <code class="language-plaintext highlighter-rouge">ProviderManager</code>로 권한을 담은 토큰을 전달한다. <br /> → 인증이 완료되면, 사용자 정보를 담은 Authentication 객체를 반환</p><li><p><code class="language-plaintext highlighter-rouge">ProviderManager</code>는 검증된 token을 <code class="language-plaintext highlighter-rouge">AuthenticationFilter</code>로 전달한다.</p><li><p><code class="language-plaintext highlighter-rouge">AuthenticationFilter</code>는 검증된 token(Authentication 객체)을 <code class="language-plaintext highlighter-rouge">SecurityContextHolder</code>에 있는 <code class="language-plaintext highlighter-rouge">SecurityContext</code>에 저장</p></ul><p><br /><br /></p><p>☑️ UsernamePasswordAuthenticationFilter란</p><p>Form based Authentication 방식으로 인증을 진행할 때 아이디, 패스워드 데이터를 파싱하여 인증 요청을 위임하는 필터이다.</p><p>유저가 로그인 창에서 Login을 시도할 때 보내지는 요청에서 아이디(username)와 패스워드(password) 데이터를 가져온 후</p><p>인증을 위한 토큰을 생성 후 인증을 다른 쪽에 위임하는 역할을 하는 필터이다.</p><p><br /></p><p>Spring Boot 기반의 HttpSecurity를 설정하는 코드에서 <code class="language-plaintext highlighter-rouge">http.formLogin();</code> 을 사용하면</p><p>시큐리티에서는 기본적으로 UsernamePasswordAuthenticationFilter 을 사용하게 된다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">SecurityFilterChain</span> <span class="nf">filterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span><span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p><br /><br /></p><p>OAuth 로그인을 하게 된다면 UsernamePasswordAuthenticationFilter 대신 <strong>OAuth2LoginAuthenticationFilter</strong> 가 호출된다.</p><p>두 필터의 상위 클래스는 AbstractAuthenticationProcessingFilter이다.</p><p><br /></p><p>스프링 시큐리티는 AbstractAuthenticationProcessingFilter를 호출하고,</p><p>로그인 방식에 따라 구현체인 UsernamePasswordAuthenticationFilter 와 <strong>OAuth2LoginAuthenticationFilter</strong> 가 동작하는 방식이다.</p><p><br /><br /><br /></p><h3 id="oauth2-flow"><span class="mr-2">OAuth2 flow</span><a href="#oauth2-flow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><strong>1.</strong> OAuth2 login flow는 맨처음 Request URL을 보내면서 시작된다.</p><p><code class="language-plaintext highlighter-rouge">http://localhost:8080/oauth2/authorize/kakao</code></p><p><br /></p><p>Spring Security OAuth 2.0 기본 요청 경로는 <code class="language-plaintext highlighter-rouge">/oauth2/authorization/{registrationId}</code> 이다.</p><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/oauth2/authorization/kakao"</span><span class="nt">&gt;</span>kakao<span class="nt">&lt;/a&gt;</span>
</pre></table></code></div></div><p><img data-src="https://github.com/haedal-uni/haedal-uni.github.io/assets/74857364/4bfab101-5db0-4a38-a978-eb038f042f24" alt="image" data-proofer-ignore></p><p><br /></p><p>위와 같은 주소를 사용하려면 back과 front의 주소가 같아야한다.</p><p>만약에 back과 front가 주소가 다를 경우 back의 주소를 작성해야한다.</p><p>ex) <code class="language-plaintext highlighter-rouge">&lt;a href="https://backend.haedal.com/oauth2/authorization/kakao"&gt;kakao&lt;/a&gt;</code></p><p>참고 글 : <a href="https://haedal-uni.github.io/posts/%EB%B0%B0%ED%8F%AC-%ED%9B%84-OAUTH2-%EC%88%98%EC%A0%95/">배포 후 oauth2 수정</a></p><p><br /><br /></p><p><strong>2.</strong> resource server는 client의 id와 redirect_uri를 확인한다.</p><p><br /><br /></p><p><strong>3.</strong> 해당 값이 같으면 Resource Server가 Resource Owner에게 Client에게 권한을 허용할 것인지 메세지를 띄워 권한을 확인한다.</p><p><br /><br /></p><p><strong>4.</strong> 임시 비밀번호 같은 authroization code를 Resource Server가 Resource Owner에게 주면 Resource Owner는 Clinet에게 준다.</p><p>*여기서 Resource Owner는 authroization code를 받았는지도 모른다.</p><p><code class="language-plaintext highlighter-rouge">Location: ${REDIRECT_URI}?code=${AUTHORIZE_CODE}</code></p><p><code class="language-plaintext highlighter-rouge">http://localhost:8080/login/oauth2/code/kakao?code = skfjskdjfaei</code> 이런 식으로 넘겨준다.</p><p>→ 카카오의 유저 정보를 모아 놓은 서버에서 해당 유저가 있기 때문에 있는 유저다 라고 알려주는 것</p><p><br /><br /></p><p><strong>5.</strong> JwtAuthenticationFilter가 토큰을 처리한다.</p><p><br /><br /></p><p><strong>6.</strong> Resource Owner의 정보에 접근하기 위해 Access Token이 필요하며</p><p>Resource Server에서 요구하는 정보 grant_type, client_id, redirect_uri, code를 보낸다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>curl -v -X POST "https://kauth.kakao.com/oauth/token" \
 -H "Content-Type: application/x-www-form-urlencoded" \
 -d "grant_type=authorization_code" \
 -d "client_id=${REST_API_KEY}" \
 --data-urlencode "redirect_uri=${REDIRECT_URI}" \
 -d "code=${AUTHORIZE_CODE}"
</pre></table></code></div></div><p><br /><br /></p><p><strong>7.</strong> AccessToken을 받는다.</p><p>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =</p><p>여기까지가 oauth2과정으로 인증이 통과되었다는 것은 로그인 성공을 의미한다.</p><p>이 다음은 custom하여 인가과정을 작성한 것인데 나는 OAuth2+JWT를 적용했다.</p><p><br /><br /></p><p><strong>8.</strong> SecurityConfig에서 정의한 CustomOAuthService는 인증된 사용자의 세부사항을 확인해서 db에 없을 경우 값을 저장한다.</p><p><br /><br /></p><p><strong>9.</strong> 만일 CustomOAuthService가 성공이라면 OAuth2SuccessHandler가 실행되어서</p><p>JWT authentication token(인증 토큰)을 만들고 redirect_uri로 간다.</p><p>(queryString에 jwtToken을 넣는다.)</p><p><br /><br /></p><p><strong>10.</strong> 만일 CustomOAuthService에서 에러가 발생한다면</p><p><code class="language-plaintext highlighter-rouge">throw new OAuth2AuthenticationException(new OAuth2Error("error"), new RuntimeException("에러 발생!!"));</code></p><p>와 같이 작성하여 Oauth2FailureHandler가 실행되게 한다.</p><p><br /><br /><br /></p><h3 id="jwt"><span class="mr-2">JWT</span><a href="#jwt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>JWT는 Claim 기반 방식을 사용한다.</p><p>여기서 Claim이란 사용자에 대한 속성 값들을 가리킨다.</p><p>즉, JWT은 의미있는 토큰 (사용자의 상태를 포함) 으로 구성되어 있기 때문에,</p><p>Auth Server에 검증 요청을 보내야만 했던 과정을 생략하고</p><p>각 서버에서 수행할 수 있게 되어 비용 절감 및 Stateless 아키텍처를 구성할 수 있다.</p><p><br /></p><ul><li><p>클라이언트 (사용자) 는 Auth Server에 로그인을 한다.</p><li><p>Auth Server에서 인증을 완료한 사용자는 JWT 토큰을 전달 받는다.</p><li><p>클라이언트는 특정 애플리케이션 서버에 리소스 (서비스에 필요한 데이터) 를 요청할 때,</p><p>앞서 전달 받은 JWT 토큰을 Authorization Header에 넣어 전달한다.</p><li><p>애플리케이션 서버는 전달 받은 JWT 토큰의 유효성을 직접 검사하여 사용자 인증을 할 수 있다.</p></ul><p><br /></p><p>고려해야 할 점은, 사용자 인증 정보가 필요한 요청을 보낼 때 헤더에 JWT 토큰 값을 넣어 보내야 하기 때문에</p><p>데이터가 증가하여 네트워크 부하가 늘어날 수 있다.</p><p>또한 토큰 자체에 사용자 정보를 담고 있기 때문에 JWT가 만료되기 전에 탈취당하면 서버에서 처리할 수 있는 일이 없다.</p><p>JWT 방식은 한 번 만들어 클라이언트에게 전달하면 제어가 불가능하기 때문에 만료 시간을 필수적으로 넣어 주어야 한다.</p><p><br /><br /><br /><br /></p><h2 id="code-작성"><span class="mr-2">code 작성</span><a href="#code-작성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>나는 kakao, naver, google 3개를 적용했는데 아래는 kakao만 작성했다.</p><p><br /></p><p>[흐름 정리]</p><p>JwtTokenProvider에서 OAuth2 로그인 과정이 수행된다.</p><p><br /></p><p>SecurityConfig에서 OAuth2로그인 성공시에 CustomOAuthService에서 처리를 한다.</p><p>OAuth2 Filter 단에서 직접 커스텀한 OAuth2 Service의 “loadUser()” 메소드가 실행된다.</p><p><br /></p><p>로그인을 성공하게 되면 OAuth2SuccessHandler의 “onAuthenticationSuccess” 메소드가 실행된다.</p><p>OAuth2SuccessHandler에서 최초 로그인 확인 및 JWT 생성 및 응답 과정이 실행된다.</p><p><br /></p><p>*모든 과정은 Spring Security Filter 과정에서 수행된다. → Login Controller는 존재하지 않는다.</p><p><br /><br /><br /></p><h3 id="oauth-20-설정"><span class="mr-2">OAuth 2.0 설정</span><a href="#oauth-20-설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>// securtiy
implementation 'org.springframework.boot:spring-boot-starter-security'
    
implementation 'io.jsonwebtoken:jjwt:0.9.1' // jwt
    
implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
    
implementation 'org.springframework.boot:spring-boot-configuration-processor'
// 소셜 로그인을 통한 인증과 권한 처리를 쉽게 할 수 있게 해준다.
</pre></table></code></div></div><p><br /><br /><br /></p><p><strong>application.properties</strong></p><p>*application.properties에서 spring.profiles.includes = <code class="language-plaintext highlighter-rouge">name</code>이라고 작성하면 <br /> application-<code class="language-plaintext highlighter-rouge">name</code>.properties 부분을 작성할 수 있다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>spring.profiles.include=oauth
</pre></table></code></div></div><p>application.properties에서 <br /> <code class="language-plaintext highlighter-rouge">spring.profiles.includes = oauth</code>를 작성한 후 application-oauth-properties를 작성했다.</p><p><br /><br /></p><p><strong>application-oauth.properties</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre># kakao about uri
spring.security.oauth2.client.provider.kakao.user-name-attribute=id
spring.security.oauth2.client.provider.kakao.authorization-uri=https://kauth.kakao.com/oauth/authorize
spring.security.oauth2.client.provider.kakao.token-uri=https://kauth.kakao.com/oauth/token
spring.security.oauth2.client.provider.kakao.user-info-uri = https://kapi.kakao.com/v2/user/me


# kakao certification need application information
spring.security.oauth2.client.registration.kakao.client-name=kakao
spring.security.oauth2.client.registration.kakao.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.kakao.client-id = 


# kakao certification uses method &amp; userinfo scope
spring.security.oauth2.client.registration.kakao.client-authentication-method=POST
spring.security.oauth2.client.registration.kakao.client-secret = 
spring.security.oauth2.client.registration.kakao.redirect-uri=http://localhost:8080/login/oauth2/code/kakao
spring.security.oauth2.client.registration.kakao.scope=profile_nickname, account_email
</pre></table></code></div></div><p><img data-src="https://github.com/haedal-uni/haedal-uni.github.io/assets/74857364/e3b2e02c-0d53-4226-81be-9d939ad60bbf" alt="image" data-proofer-ignore></p><p><code class="language-plaintext highlighter-rouge">{baseUrl}/login/oauth2/code/{registrationId}</code> 로 redirect-uri를 받고 있다고 해서</p><p>login/oauth2/code/kakao로 Redirection Endpoint를 작성했다.</p><p><br /><br /><br /><br /></p><h2 id="domain"><span class="mr-2">domain</span><a href="#domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="user"><span class="mr-2">User</span><a href="#user" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre><td class="rouge-code"><pre><span class="nd">@Getter</span>
<span class="nd">@Entity</span>
<span class="nd">@NoArgsConstructor</span><span class="o">(</span><span class="n">access</span> <span class="o">=</span> <span class="nc">AccessLevel</span><span class="o">.</span><span class="na">PROTECTED</span><span class="o">)</span>
<span class="nd">@ToString</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="nc">UserDetails</span> <span class="o">{</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DEFAULT_PROFILE_IMG_PATH</span> <span class="o">=</span> <span class="s">"images/default-profile.png"</span><span class="o">;</span>

   <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
   <span class="nd">@Id</span>
   <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"user_id"</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
   
   <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">nickname</span><span class="o">;</span>
   
   <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
   
   <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
   
   <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
   <span class="nd">@Enumerated</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">EnumType</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">UserRole</span> <span class="n">role</span><span class="o">;</span>
   
   <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
   <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// 1</span>
   
   <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">socialId</span><span class="o">;</span>
   
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">social</span><span class="o">;</span>
   
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">profile</span> <span class="o">=</span> <span class="no">DEFAULT_PROFILE_IMG_PATH</span><span class="o">;</span>

   <span class="nd">@Builder</span> <span class="c1">// UserMapper와 연결</span>
   <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="nc">String</span> <span class="n">socialId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">email</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">,</span> <span class="nc">UserRole</span> <span class="n">role</span><span class="o">,</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">nickname</span><span class="o">,</span> <span class="nc">String</span> <span class="n">social</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">socialId</span> <span class="o">=</span> <span class="n">socialId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">nickname</span> <span class="o">=</span> <span class="n">nickname</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">role</span> <span class="o">=</span> <span class="n">role</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nc">UserRole</span><span class="o">.</span><span class="na">USER</span> <span class="o">:</span> <span class="n">role</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">profile</span> <span class="o">=</span> <span class="no">DEFAULT_PROFILE_IMG_PATH</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">social</span> <span class="o">=</span> <span class="n">social</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">enabled</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><br /><br /></p><h3 id="userrole"><span class="mr-2">UserRole</span><a href="#userrole" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nd">@Getter</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">UserRole</span> <span class="o">{</span>
   <span class="no">USER</span><span class="o">,</span>  <span class="c1">// 사용자 권한</span>
   <span class="no">ADMIN</span><span class="o">;</span>  <span class="c1">// 관리자 권한</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="nc">UserRole</span> <span class="nf">of</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">UserRole</span> <span class="n">role</span> <span class="o">:</span> <span class="n">values</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">role</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="k">return</span> <span class="n">role</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BadConstantException</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><br /><br /></p><h3 id="usermapper"><span class="mr-2">UserMapper</span><a href="#usermapper" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserMapper</span> <span class="o">{</span>
    <span class="c1">// 인증</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">User</span> <span class="nf">ofKakao</span><span class="o">(</span><span class="nc">OAuth2User</span> <span class="n">oAuth2User</span><span class="o">,</span> <span class="nc">String</span> <span class="n">nickname</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">oAuth2User</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">();</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">kakao_account</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"kakao_account"</span><span class="o">);</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">properties</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">oAuth2User</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"properties"</span><span class="o">);</span>
        
        <span class="k">return</span> <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">socialId</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">email</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">kakao_account</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">""</span><span class="o">)</span>
            <span class="o">.</span><span class="na">username</span><span class="o">(</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">properties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"nickname"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">nickname</span><span class="o">(</span><span class="n">nickname</span><span class="o">)</span>
            <span class="o">.</span><span class="na">social</span><span class="o">(</span><span class="s">"kakao"</span><span class="o">)</span>
<span class="c1">//            .picture((String)attributes.get("picture"))</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="c1">// 인가</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">User</span> <span class="nf">of</span><span class="o">(</span><span class="nc">OAuth2User</span> <span class="n">oAuth2User</span><span class="o">,</span> <span class="nc">String</span> <span class="n">nickname</span><span class="o">)</span> <span class="o">{</span><span class="c1">// nickname과 role만 있으면 됨 </span>
        <span class="kt">var</span> <span class="n">authority</span> <span class="o">=</span> <span class="n">oAuth2User</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">auth</span> <span class="o">=</span> <span class="n">authority</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">"["</span><span class="o">,</span><span class="s">""</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">"]"</span><span class="o">,</span><span class="s">""</span><span class="o">);</span>
            <span class="k">return</span> <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">""</span><span class="o">)</span>
                <span class="o">.</span><span class="na">nickname</span><span class="o">(</span><span class="n">nickname</span><span class="o">)</span>
                <span class="o">.</span><span class="na">role</span><span class="o">(</span><span class="nc">UserRole</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">auth</span><span class="o">))</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>사용자가 OAuth 2.0 Provider를 통해 성공적으로 인증되면 <code class="language-plaintext highlighter-rouge">OAuth2User.getAuthorities()</code>를 사용하여 권한을 얻을 수 있다.</p><p><br /><br /><br /></p><h3 id="userdetailservice"><span class="mr-2">UserDetailService</span><a href="#userdetailservice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetailService</span> <span class="kd">extends</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>
   <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">nickname</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UserNotFoundException</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p><br /><br /><br /></p><h3 id="userdetailserviceimpl"><span class="mr-2">UserDetailServiceImpl</span><a href="#userdetailserviceimpl" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>JwtTokenProvider가 제공한 사용자 정보로 DB에서 알맞은 사용자 정보를 가져와 UserDetails 생성</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDetailServiceImpl</span> <span class="kd">implements</span> <span class="nc">UserDetailService</span> <span class="o">{</span><span class="c1">// @AuthenticationPrincipal에서 값을 받아오기 위해서는 아래 코드를 작성해야 한다.</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

   <span class="c1">// User entity의 id 값 가져오기 (인증)</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[loadUserByUsername] loadUserByUsername 수행. email : {}"</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">UserNotFoundException</span><span class="o">();</span>
      <span class="o">});</span>

   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>JwtTokenProvider에서 토큰의 payload에서 가져온 email 정보를 통해 Repository에서 유저 정보를 가져와야한다.</p><p>그러기 위해서 UserDetailSerivce를 구현하는 클래스를 생성하여 loadUserByUsername 오버라이드 해서 이를통해 가져오면 된다.</p><p><br /><br /><br /></p><h3 id="userrepository"><span class="mr-2">UserRepository</span><a href="#userrepository" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p><br /><br /><br /><br /></p><h2 id="config"><span class="mr-2">config</span><a href="#config" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="securityconfig"><span class="mr-2">SecurityConfig</span><a href="#securityconfig" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@EnableWebSecurity</span> <span class="c1">//spring security 활성화를 위한 annotation</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="o">{</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JwtTokenProvider</span> <span class="n">jwtTokenProvider</span><span class="o">;</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomOAuthService</span> <span class="n">oAuthService</span><span class="o">;</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">OAuth2SuccessHandler</span> <span class="n">successHandler</span><span class="o">;</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Oauth2FailureHandler</span> <span class="n">failureHandler</span><span class="o">;</span>

   <span class="nd">@Bean</span>
   <span class="kd">public</span> <span class="nc">SecurityFilterChain</span> <span class="nf">filterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span><span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span> <span class="c1">// rest api 에서는 csrf 공격으로부터 안전하고 매번 api 요청으로부터 csrf 토큰을 받지 않아도 되어 disable로 설정</span>
            <span class="o">.</span><span class="na">sessionManagement</span><span class="o">();</span> <span class="c1">// Rest Api 기반 애플리케이션 동작 방식 설정</span>

      <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/css/**"</span><span class="o">,</span> <span class="s">"/login/**"</span><span class="o">,</span> <span class="s">"/oauth2/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/admin/**"</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">"ADMIN"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">();</span>


      <span class="n">http</span>
    <span class="o">.</span><span class="na">oauth2Login</span><span class="o">()</span> <span class="c1">// OAuth2 로그인 설정 시작점</span>
    <span class="o">.</span><span class="na">userInfoEndpoint</span><span class="o">()</span> <span class="c1">// OAuth2 로그인 성공 이후 사용자 정보를 가져올 때 설정 담당</span>
    <span class="o">.</span><span class="na">userService</span><span class="o">(</span><span class="n">oAuthService</span><span class="o">)</span> <span class="c1">// OAuth2 로그인 성공 시, 후작업을 진행할 UserService 인터페이스 구현체 등록</span>
            <span class="o">.</span><span class="na">and</span><span class="o">()</span>
            <span class="o">.</span><span class="na">successHandler</span><span class="o">(</span><span class="n">successHandler</span><span class="o">)</span>
            <span class="o">.</span><span class="na">failureHandler</span><span class="o">(</span><span class="n">failureHandler</span><span class="o">)</span>
            <span class="o">.</span><span class="na">userInfoEndpoint</span><span class="o">().</span><span class="na">userService</span><span class="o">(</span><span class="n">oAuthService</span><span class="o">);</span>
        
      <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="k">new</span> <span class="nc">JwtAuthenticationFilter</span><span class="o">(</span><span class="n">jwtTokenProvider</span><span class="o">),</span> <span class="nc">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="c1">// JwtAuthenticationFilter UsernamePasswordAuthenticationFilter보다 앞으로 설정</span>
      <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Spring Security는 여러가지의 필터를 순차적으로 돌며 해당되는 필터를 실행한다.</p><p>그리고 인증에 관련된 책임은 AuthenticationManager에 의해 수행된다.</p><p><br /></p><p>기본적으로 Filter로 수행되는 것은 Form기반의 아이디와 비밀번호로 진행되는 UsernamePasswordAuthenticationFilter가 수행된다.</p><p>하지만 JWT 인증을 위해서는 새로운 필터를 만들어 UsernamePasswordAuthenticationFilter보다 먼저 수행되게 설정해야 한다.</p><p><br /><br /></p><p><code class="language-plaintext highlighter-rouge">.antMatchers("/admin/**").hasAuthority("ADMIN")</code></p><p>Spring Security에서 제공하는 역할(Role)과 권한(Authority)이 있다.</p><p>A와 B는 둘 다 관리자의 역할을 가지고 있지만 원칙상 A 계정은 게시판의 글을 등록할 수만 있으며, <br /> B 계정은 등록된 글을 삭제만 할 수 있다고 했을 때 역할은 같지만 권한은 다르게 설정해야 할 것이다.</p><p>hasRole 메소드에는 ‘ROLE_’ 접두어를 내부적으로 붙여준다.</p><p>따라서 hasRole을 사용할 떄는 “ROLE_ADMIN”과 같이 작성해야하며 DB에도 동일하게 저장되어있어야한다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>alter table user 
change column role 
role enum('ROLE_USER','ROLE_ADMIN');
</pre></table></code></div></div><p><a href="https://codediary21.tistory.com/73">(Spring Security) OAuth2 서비스 구현 정리</a> <br /> <a href="https://jungeunlee95.github.io/java/2019/07/18/3-SpringSecurity-Authorization(%EA%B6%8C%ED%95%9C)-%EC%84%A4%EC%A0%95(ROLE),-TagLib-authorize-%EC%B6%94%EA%B0%80/">3 Spring Security - Authorization(권한) 설정(ROLE), TagLib authorize 추가</a> <br /> <br /><br /></p><p>☑️ 참고</p><p>어느 곳에서는 addFilterBefore 대신 addFilterAfter를 사용했다.</p><p><code class="language-plaintext highlighter-rouge">http.addFilterAfter(jwtAuthenticationFilter, LogoutFilter.class);</code></p><p><br /></p><p>인증을 처리하는 기본필터 UsernamePasswordAuthenticationFilter 대신</p><p>별도의 인증 로직을 가진 필터를 생성하고 사용하고 싶을 때 아래와 같이 필터를 등록한다.</p><ul><li><p>addFilterBefore <br /> 지정된 필터 앞에 커스텀 필터를 추가 (UsernamePasswordAuthenticationFilter 보다 먼저 실행된다)</p><li><p>addFilterAfter <br /> 지정된 필터 뒤에 커스텀 필터를 추가 (UsernamePasswordAuthenticationFilter 다음에 실행된다.)</p><li><p>addFilterAt <br /> 지정된 필터의 순서에 커스텀 필터가 추가된다</p></ul><p><br /><br /><br /></p><h3 id="passwordencoderconfiguration"><span class="mr-2">PasswordEncoderConfiguration</span><a href="#passwordencoderconfiguration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>config에 PasswordEncoder를 넣었다가 순환참조 error가 난 적이 있었는데 따로 빼서 등록을 해야 된다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordEncoderConfiguration</span> <span class="o">{</span>
   <span class="nd">@Bean</span>
   <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">(){</span>
      <span class="k">return</span> <span class="nc">PasswordEncoderFactories</span><span class="o">.</span><span class="na">createDelegatingPasswordEncoder</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><br /><br /><br /><br /></p><h2 id="oauth"><span class="mr-2">OAuth</span><a href="#oauth" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><p>사용자가 소셜 로그인을 정상적으로 완료</p><li><p>AbstractAuthenticationProcessingFilter에서 OAuth2 로그인 과정을 호출</p><li><p>Resource Server에서 넘겨주는 정보를 토대로 OAuth2LoginAuthenticationFilter의 <code class="language-plaintext highlighter-rouge">attemptAuthentication()</code>에서 인증 과정을 수행</p><li><p>attemptAuthentication</p><ul><li><p><img data-src="https://user-images.githubusercontent.com/74857364/221833142-14c1d530-2a96-4e54-b9c1-ea00234c9d1e.png" alt="image" data-proofer-ignore></p><li><p><code class="language-plaintext highlighter-rouge">attemptAuthentication()</code> 처리 과정에서 OAuth2AuthenticationToken을 생성하기 위해 OAuth2LoginAuthenticationProvider의 <code class="language-plaintext highlighter-rouge">authenticate()</code>를 호출</p></ul><li><p>authenticate</p><ul><li><p><img data-src="https://user-images.githubusercontent.com/74857364/221833673-b06ac255-914f-4978-8328-23d901846d70.png" alt="image" data-proofer-ignore></p><li><p><code class="language-plaintext highlighter-rouge">authenticate()</code> 처리 과정에서 OAuth2User를 생성하기 위해 OAuth2UserService의 <code class="language-plaintext highlighter-rouge">loadUser()</code>를 호출</p></ul><li><p>OAuth2UserService의 기본 구현체는 DefaultOAuth2UserService이지만, <br /> 커스텀한 OAuth2User를 반환하도록 구현하고 싶었으므로 직접 구현한 CustomOAuth2UserService의 <code class="language-plaintext highlighter-rouge">loadUser()</code>가 호출된다.</p></ul><p><br /><br /></p><h3 id="customoauthservice"><span class="mr-2">CustomOAuthService</span><a href="#customoauthservice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>DefaultOAuth2UserService를 구현한 OAuth2UserService 작성</p><p>SecurityConfig에서 OAuth2로그인 성공시에 CustomOAuthService에서 처리를 한다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomOAuthService</span> <span class="kd">implements</span> <span class="nc">OAuth2UserService</span><span class="o">&lt;</span><span class="nc">OAuth2UserRequest</span><span class="o">,</span> <span class="nc">OAuth2User</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">HttpSession</span> <span class="n">httpSession</span><span class="o">;</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="nc">OAuth2User</span> <span class="nf">loadUser</span><span class="o">(</span><span class="nc">OAuth2UserRequest</span> <span class="n">userRequest</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">OAuth2AuthenticationException</span> <span class="o">{</span>
    <span class="c1">// DefaultOAuth2UserService 객체를 성공정보를 바탕으로 만든다.</span>
      <span class="nc">OAuth2UserService</span><span class="o">&lt;</span><span class="nc">OAuth2UserRequest</span><span class="o">,</span> <span class="nc">OAuth2User</span><span class="o">&gt;</span> <span class="n">delegate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultOAuth2UserService</span><span class="o">();</span>
    
    <span class="c1">// 생성된 Service 객체로 부터 User를 받는다.</span>
      <span class="nc">OAuth2User</span> <span class="n">oAuth2User</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">loadUser</span><span class="o">(</span><span class="n">userRequest</span><span class="o">);</span>
    
      <span class="c1">// OAuth2 서비스 id (구글, 카카오, 네이버)</span>
      <span class="nc">String</span> <span class="n">registrationId</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">getClientRegistration</span><span class="o">().</span><span class="na">getRegistrationId</span><span class="o">();</span> <span class="c1">// kakao</span>
    
      <span class="c1">// OAuth2 로그인 진행 시 키가 되는 필드 값(PK)</span>
      <span class="nc">String</span> <span class="n">userNameAttributeName</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">getClientRegistration</span><span class="o">().</span><span class="na">getProviderDetails</span><span class="o">().</span><span class="na">getUserInfoEndpoint</span><span class="o">()</span>
            <span class="o">.</span><span class="na">getUserNameAttributeName</span><span class="o">();</span> <span class="c1">// kakao는 id</span>
        
      <span class="c1">// OAuth2 로그인을 통해 가져온 OAuth2User의 attribute를 담아주는 of 메소드</span>
     <span class="c1">// SuccessHandler가 사용할 수 있도록 등록해준다.</span>
      <span class="nc">OAuth2Attribute</span> <span class="n">oAuth2Attribute</span> <span class="o">=</span> <span class="nc">OAuth2Attribute</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">registrationId</span><span class="o">,</span> <span class="n">userNameAttributeName</span><span class="o">,</span> <span class="n">oAuth2User</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">());</span>
    
      <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">oAuth2Attribute</span><span class="o">.</span><span class="na">getEmail</span><span class="o">()).</span><span class="na">orElseGet</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
         <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[db save] : user social login"</span><span class="o">);</span>
         <span class="nc">User</span> <span class="n">saved</span> <span class="o">=</span> <span class="nc">UserMapper</span><span class="o">.</span><span class="na">ofKakao</span><span class="o">(</span><span class="n">oAuth2User</span><span class="o">,</span> <span class="n">nickname</span><span class="o">);</span>
         <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">saved</span><span class="o">);</span>
         <span class="k">return</span> <span class="n">saved</span><span class="o">;</span>
      <span class="o">});</span>
    
      <span class="k">if</span> <span class="o">(!</span><span class="n">user</span><span class="o">.</span><span class="na">isEnabled</span><span class="o">())</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">OAuth2AuthenticationException</span><span class="o">(</span><span class="k">new</span> <span class="nc">OAuth2Error</span><span class="o">(</span><span class="s">"Not Found"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">UserNotFoundException</span><span class="o">());</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">memberAttribute</span> <span class="o">=</span> <span class="n">oAuth2Attribute</span><span class="o">.</span><span class="na">convertToMap</span><span class="o">();</span> <span class="c1">// {name=kakao에서 설정한 이름, id=email, key=email, email=test@kakao.com, picture=null}</span>
      <span class="n">memberAttribute</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
      
      <span class="c1">// 로그인한 user를 return한다.</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultOAuth2User</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleGrantedAuthority</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getRole</span><span class="o">()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">())),</span> <span class="n">memberAttribute</span><span class="o">,</span> <span class="s">"email"</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>☑️ 참고</p><p><code class="language-plaintext highlighter-rouge">OAuth2UserService oAuth2UserService = new DefaultOAuth2UserService();</code> 로 적은 글이 있어서 찾아봤다.</p><p><img data-src="https://user-images.githubusercontent.com/74857364/221864906-4087f8a9-e4fa-4233-8344-1d749f3e6dcc.png" alt="image" data-proofer-ignore></p><p>→ <code class="language-plaintext highlighter-rouge">OAuth2UserService&lt;OAuth2UserRequest, OAuth2User&gt; oAuth2UserService = new DefaultOAuth2UserService();</code></p><p><br /><br /><br /></p><h3 id="oauth2attribute"><span class="mr-2">OAuth2Attribute</span><a href="#oauth2attribute" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>OAuth2 로그인을 통해서 가져온 OAuth2User의 정보를 담아주기 위한 OAuth2Attribute를 생성한다.</p><p><br /></p><p>스프링 부트에서는 google 및 facebook에 대한 OAuth2정보를 기본적으로 제공한다.</p><p>하지만 Kakao와 NAVER 는 스프링 부트에서 기본적인 정보를 제공하지 않으므로</p><p>아래와 같이 따로 해당 정보를 제공하는 클래스를 작성해야한다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre><td class="rouge-code"><pre><span class="nd">@Builder</span><span class="o">(</span><span class="n">access</span> <span class="o">=</span> <span class="nc">AccessLevel</span><span class="o">.</span><span class="na">PRIVATE</span><span class="o">)</span>
<span class="nd">@Getter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2Attribute</span> <span class="o">{</span>
   <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">;</span> <span class="c1">// OAuth2 반환하는 유저 정보 Map</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">attributeKey</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">picture</span><span class="o">;</span>

   <span class="kd">static</span> <span class="nc">OAuth2Attribute</span> <span class="nf">of</span><span class="o">(</span><span class="nc">String</span> <span class="n">provider</span><span class="o">,</span> <span class="nc">String</span> <span class="n">attributeKey</span><span class="o">,</span>
                       <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">switch</span> <span class="o">(</span><span class="n">provider</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">case</span> <span class="s">"google"</span><span class="o">:</span>
            <span class="k">return</span> <span class="nf">ofGoogle</span><span class="o">(</span><span class="n">attributeKey</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
         <span class="k">case</span> <span class="s">"kakao"</span><span class="o">:</span>
            <span class="k">return</span> <span class="nf">ofKakao</span><span class="o">(</span><span class="s">"email"</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
         <span class="k">case</span> <span class="s">"naver"</span><span class="o">:</span>
            <span class="k">return</span> <span class="nf">ofNaver</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
         <span class="k">default</span><span class="o">:</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">();</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kd">static</span> <span class="nc">OAuth2Attribute</span> <span class="nf">ofGoogle</span><span class="o">(</span><span class="nc">String</span> <span class="n">attributeKey</span><span class="o">,</span>
                                 <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">OAuth2Attribute</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">email</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">picture</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"picture"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">attributes</span><span class="o">(</span><span class="n">attributes</span><span class="o">)</span>
            <span class="o">.</span><span class="na">attributeKey</span><span class="o">(</span><span class="n">attributeKey</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kd">static</span> <span class="nc">OAuth2Attribute</span> <span class="nf">ofKakao</span><span class="o">(</span><span class="nc">String</span> <span class="n">attributeKey</span><span class="o">,</span>
                                 <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">kakaoAccount</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"kakao_account"</span><span class="o">);</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">kakaoProfile</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">kakaoAccount</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"profile"</span><span class="o">);</span>

      <span class="k">return</span> <span class="nc">OAuth2Attribute</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">kakaoProfile</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"nickname"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">email</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">kakaoAccount</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">picture</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">kakaoProfile</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"profile_image_url"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">attributes</span><span class="o">(</span><span class="n">kakaoAccount</span><span class="o">)</span>
            <span class="o">.</span><span class="na">attributeKey</span><span class="o">(</span><span class="n">attributeKey</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kd">static</span> <span class="nc">OAuth2Attribute</span> <span class="nf">ofNaver</span><span class="o">(</span><span class="nc">String</span> <span class="n">attributeKey</span><span class="o">,</span>
                                 <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"response"</span><span class="o">);</span>

      <span class="k">return</span> <span class="nc">OAuth2Attribute</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">email</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">picture</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"profile_image"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">attributes</span><span class="o">(</span><span class="n">response</span><span class="o">)</span>
            <span class="o">.</span><span class="na">attributeKey</span><span class="o">(</span><span class="n">attributeKey</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
   <span class="o">}</span>

   <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">convertToMap</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
      <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="n">attributeKey</span><span class="o">);</span>
      <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"key"</span><span class="o">,</span> <span class="n">attributeKey</span><span class="o">);</span>
      <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
      <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"email"</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
      <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"picture"</span><span class="o">,</span> <span class="n">picture</span><span class="o">);</span>

      <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><br /><br /><br /></p><h3 id="oauth2successhandler"><span class="mr-2">OAuth2SuccessHandler</span><a href="#oauth2successhandler" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2SuccessHandler</span> <span class="kd">implements</span> <span class="nc">AuthenticationSuccessHandler</span> <span class="o">{</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JwtTokenProvider</span> <span class="n">jwtProvider</span><span class="o">;</span>
   <span class="nd">@Value</span><span class="o">(</span><span class="s">"${oauth.redirection.url}"</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="no">REDIRECTION_URL</span><span class="o">;</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationSuccess</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span>
			<span class="nc">IOException</span> <span class="o">{</span>
      <span class="nc">OAuth2User</span> <span class="n">oAuth2User</span> <span class="o">=</span> <span class="o">(</span><span class="nc">OAuth2User</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
      <span class="nc">String</span> <span class="n">email</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">oAuth2User</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">);</span>
      <span class="nc">User</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">(</span><span class="nl">UserNotFoundException:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">nickname</span> <span class="o">=</span> <span class="n">userInfo</span><span class="o">.</span><span class="na">getNickname</span><span class="o">();</span>
      <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="nc">UserMapper</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">oAuth2User</span><span class="o">,</span> <span class="n">nickname</span><span class="o">);</span> <span class="c1">// kakao type으로 넣기</span>
      <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">generateToken</span><span class="o">(</span><span class="n">user</span><span class="o">);</span> <span class="c1">// string 으로 받는다</span>

      <span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">getRedirectionURI</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">user</span><span class="o">));</span>
	<span class="o">}</span>

   <span class="kd">private</span> <span class="nc">String</span> <span class="nf">getRedirectionURI</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">,</span> <span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getRole</span><span class="o">().</span><span class="na">name</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">UserRole</span><span class="o">.</span><span class="na">USER</span><span class="o">.</span><span class="na">name</span><span class="o">())){</span>
         <span class="k">return</span> <span class="nc">UriComponentsBuilder</span><span class="o">.</span><span class="na">fromUriString</span><span class="o">(</span><span class="no">REDIRECTION_URL</span><span class="o">).</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"token"</span><span class="o">,</span> <span class="n">token</span><span class="o">).</span><span class="na">build</span><span class="o">().</span><span class="na">toUriString</span><span class="o">();</span>
      <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getRole</span><span class="o">().</span><span class="na">name</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">UserRole</span><span class="o">.</span><span class="na">ADMIN</span><span class="o">.</span><span class="na">name</span><span class="o">())){</span>
         <span class="k">return</span> <span class="nc">UriComponentsBuilder</span><span class="o">.</span><span class="na">fromUriString</span><span class="o">(</span><span class="no">ADMIN_REDIRECTION_URL</span><span class="o">).</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"token"</span><span class="o">,</span> <span class="n">token</span><span class="o">).</span><span class="na">build</span><span class="o">().</span><span class="na">toUriString</span><span class="o">();</span>
      <span class="o">}</span><span class="k">else</span><span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"[error] 잘못된 권한입니다."</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">};</span>
<span class="o">}</span>
</pre></table></code></div></div><p><br /><br /><br /></p><h3 id="oauth2failurehandler"><span class="mr-2">Oauth2FailureHandler</span><a href="#oauth2failurehandler" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Oauth2FailureHandler</span> <span class="kd">implements</span> <span class="nc">AuthenticationFailureHandler</span> <span class="o">{</span>
   <span class="nd">@Value</span><span class="o">(</span><span class="s">"${oauth.failure.url}"</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="no">FAILURE_URL</span><span class="o">;</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationFailure</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">AuthenticationException</span> <span class="n">exception</span><span class="o">)</span> <span class="kd">throws</span>
         <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
      <span class="n">response</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html; charset=UTF-8"</span><span class="o">);</span>

      <span class="nc">PrintWriter</span> <span class="n">printWriter</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
      <span class="n">printWriter</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&lt;script&gt;"</span><span class="o">);</span>
      <span class="n">printWriter</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"alert('%s')"</span><span class="o">,</span> <span class="n">exception</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()));</span>
      <span class="n">printWriter</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"window.location.href='%s'"</span><span class="o">,</span> <span class="no">FAILURE_URL</span><span class="o">));</span>
      <span class="n">printWriter</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&lt;/script&gt;"</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><br /><br /><br /><br /></p><h2 id="jwt-1"><span class="mr-2">jwt</span><a href="#jwt-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="jwttokenprovider"><span class="mr-2">JwtTokenProvider</span><a href="#jwttokenprovider" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Jwt Token을 생성, 인증, 권한 부여, 유효성 검사, PK 추출 등의 다양한 기능을 제공하는 클래스</p><p>JwtTokenProvider에 Token을 통해 사용자 정보를 조회할 수 있는 메서드를 작성한다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtTokenProvider</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserDetailService</span> <span class="n">userDetailsService</span><span class="o">;</span>

   <span class="nd">@Value</span><span class="o">(</span><span class="s">"${springboot.jwt.secret}"</span><span class="o">)</span>
   <span class="kd">private</span> <span class="nc">String</span> <span class="n">secretKey</span><span class="o">;</span> <span class="c1">// 토큰 생성에 필요한 key</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">TOKEN_VALID_MILISECOND</span> <span class="o">=</span> <span class="mi">1000L</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">10</span><span class="o">;</span> <span class="c1">// token 유효시간 : 10시간</span>
   <span class="kt">long</span> <span class="n">refreshPeriod</span> <span class="o">=</span> <span class="mi">1000L</span> <span class="o">*</span> <span class="mi">60L</span> <span class="o">*</span> <span class="mi">60L</span> <span class="o">*</span> <span class="mi">24L</span> <span class="o">*</span> <span class="mi">30L</span> <span class="o">*</span> <span class="mi">3L</span><span class="o">;</span>

   <span class="c1">// SecretKey 초기화</span>
   <span class="nd">@PostConstruct</span> <span class="c1">// Bean 객체로 주입된 후 수행</span>
   <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[init] JwtTokenProvider 내 secretKey 초기화 시작"</span><span class="o">);</span>

      <span class="c1">// secretKey 를 base64 형식으로 인코딩</span>
      <span class="n">secretKey</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">getEncoder</span><span class="o">().</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">secretKey</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>

      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[init] JwtTokenProvider 내 secretKey 초기화 완료"</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="nc">String</span> <span class="nf">createToken</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[createToken] 토큰 생성 시작"</span><span class="o">);</span>

      <span class="c1">// Claims 객체에 담아 Jwt Token 의 내용에 값 넣기, sub 속정에 값 추가(Uid 사용)</span>
      <span class="nc">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">claims</span><span class="o">().</span><span class="na">setSubject</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getNickname</span><span class="o">());</span>
      <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"roles"</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getRole</span><span class="o">().</span><span class="na">name</span><span class="o">());</span> <span class="c1">// 사용자 권한확인용 추가</span>
      <span class="nc">Date</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>

      <span class="c1">// Token 생성</span>
      <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">setClaims</span><span class="o">(</span><span class="n">claims</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setIssuedAt</span><span class="o">(</span><span class="n">now</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="n">now</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">+</span> <span class="no">TOKEN_VALID_MILISECOND</span><span class="o">))</span>
            <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="nc">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS256</span><span class="o">,</span> <span class="n">secretKey</span><span class="o">)</span>
            <span class="o">.</span><span class="na">compact</span><span class="o">();</span>

      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[createToken] 토큰 생성 완료"</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">token</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="c1">// 필터에서 인증에 성공시 SecurityContextHolder 에 저장할 Authentication 생성</span>
   <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">getAuthentication</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[getAuthentication] 토큰 인증 정보 조회 시작"</span><span class="o">);</span>
      <span class="nc">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">getClaims</span><span class="o">(</span><span class="n">token</span><span class="o">).</span><span class="na">getBody</span><span class="o">();</span>
      <span class="nc">String</span> <span class="n">role</span> <span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"roles"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
      <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
          <span class="o">.</span><span class="na">nickname</span><span class="o">(</span><span class="n">claims</span><span class="o">.</span><span class="na">getSubject</span><span class="o">())</span>
          <span class="o">.</span><span class="na">role</span><span class="o">(</span><span class="nc">UserRole</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">role</span><span class="o">))</span>
          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[getAuthentication] 토큰 인증 정보 조회 완료"</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getNickname</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[getUsername] 토큰 기반 회원 구별 정보 추출"</span><span class="o">);</span>
      
      <span class="c1">// 토큰을 생성할때 넣었던 sub 값 추출</span>
      <span class="nc">String</span> <span class="n">info</span> <span class="o">=</span> <span class="n">getClaims</span><span class="o">(</span><span class="n">token</span><span class="o">).</span><span class="na">getBody</span><span class="o">().</span><span class="na">getSubject</span><span class="o">();</span>
      
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[getUsername] 토큰 기반 회원 구별 정보 추출 완료"</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
   <span class="o">}</span>


   <span class="c1">// Token 유효기간 체크</span>
   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validateToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[validateToken] 토큰 유효 체크 시작"</span><span class="o">);</span>

      <span class="k">try</span> <span class="o">{</span>
         <span class="nc">Jws</span><span class="o">&lt;</span><span class="nc">Claims</span><span class="o">&gt;</span> <span class="n">claims</span> <span class="o">=</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">().</span>
               <span class="n">setSigningKey</span><span class="o">(</span><span class="n">secretKey</span><span class="o">)</span>
               <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>

         <span class="k">return</span> <span class="o">!</span><span class="n">claims</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">getExpiration</span><span class="o">().</span><span class="na">before</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>

      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[validateToken] 토큰 유효 체크 예외 발생"</span><span class="o">);</span>
         <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
   <span class="kd">private</span> <span class="nc">Jws</span><span class="o">&lt;</span><span class="nc">Claims</span><span class="o">&gt;</span> <span class="nf">getClaims</span><span class="o">(</span><span class="nc">String</span> <span class="n">jwt</span><span class="o">){</span>
      <span class="k">try</span><span class="o">{</span>
         <span class="k">return</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">().</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">secretKey</span><span class="o">).</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">jwt</span><span class="o">);</span>
      <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">SignatureException</span> <span class="n">e</span><span class="o">){</span>
         <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Invalid JWT signature"</span><span class="o">);</span>
         <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">MalformedJwtException</span> <span class="n">e</span><span class="o">){</span>
         <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Invalid JWT token"</span><span class="o">);</span>
         <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ExpiredJwtException</span> <span class="n">e</span><span class="o">){</span>
         <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Expired JWT token"</span><span class="o">);</span>
         <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">UnsupportedJwtException</span> <span class="n">e</span><span class="o">){</span>
         <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Unsupported JWT token"</span><span class="o">);</span>
         <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalArgumentException</span> <span class="n">e</span><span class="o">){</span>
         <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"JWT claims string is empty"</span><span class="o">);</span>
         <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><br /><br /><br /></p><h3 id="jwtauthenticationfilter"><span class="mr-2">JwtAuthenticationFilter</span><a href="#jwtauthenticationfilter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Jwt가 유효한 토큰인지 인증하기 위한 Filter</p><p>CustomFilter를 만들어 UsernamePasswordAuthenticationFilter보다 먼저 걸리도록 설정해야한다.</p><p>스프링 시큐리티에서는 기본적으로 토큰 처리를 위한 필터가 없으므로 구현해서 Filter Chain에 추가해야 한다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtAuthenticationFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JwtTokenProvider</span> <span class="n">jwtTokenProvider</span><span class="o">;</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">BEARER</span> <span class="o">=</span> <span class="s">"Bearer "</span><span class="o">;</span>
   <span class="nd">@Override</span>
   <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="nc">HttpHeaders</span><span class="o">.</span><span class="na">AUTHORIZATION</span><span class="o">);</span>
      <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"existsToken"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span> <span class="c1">// 토큰 존재 여부 초기화</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">isEmptyToken</span><span class="o">(</span><span class="n">token</span><span class="o">))</span> <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"existsToken"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span> <span class="c1">// 토큰이 없는 경우 false로 변경</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">token</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">BEARER</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
         <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="n">token</span> <span class="o">=</span> <span class="n">parseBearer</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">jwtTokenProvider</span><span class="o">.</span><span class="na">validateToken</span><span class="o">(</span><span class="n">token</span><span class="o">))</span> <span class="o">{</span>
         <span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">jwtTokenProvider</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
         <span class="c1">// JwtTokenProvider를 통해 Jwt 토큰을 검증 받는다.</span>
         
         <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isEmptyToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">token</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="nc">String</span> <span class="nf">parseBearer</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">token</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="no">BEARER</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>JWT 토큰 검증이 필요한 경우에만 동작하도록 조건 처리를 한다.</p><p>클라이언트에서는 Authorization Header에 토큰을 담아서 보내므로,</p><p>HttpServletRequest에서 토큰을 추출한 후, 검증하여 Authentication을 SecurityContext에 저장한다.</p><p><br /><br /><br /><br /></p><h2 id="error"><span class="mr-2">Error</span><a href="#error" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="clientregistrationrepository"><span class="mr-2">ClientRegistrationRepository</span><a href="#clientregistrationrepository" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>oauth를 적용하면서 가장많이 본 오류다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>***************************
APPLICATION FAILED TO START
***************************

Description:

Method springSecurityFilterChain in org.springframework.security.config.annotation.web.configuration.WebSecurityConfiguration required a bean of type 'org.springframework.security.oauth2.client.registration.ClientRegistrationRepository' that could not be found.


Action:

Consider defining a bean of type 'org.springframework.security.oauth2.client.registration.ClientRegistrationRepository' in your configuration.
</pre></table></code></div></div><p>위 문제는 아래와 같이 수정하다보니 해결되었다.</p><p><strong>1. properties에 정보입력하기</strong> <br /> [본문 내용 참고하기]</p><p><br /><br /></p><p><strong>2. security extends없애기</strong></p><p><a href="https://spring.io/blog/2022/02/21/spring-security-without-the-websecurityconfigureradapter">spring 공식 blog</a> 5.7.x 버전부터는 아래와 같이 변경</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfiguration</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeHttpRequests</span><span class="o">((</span><span class="n">authz</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">authz</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
            <span class="o">)</span>
            <span class="o">.</span><span class="na">httpBasic</span><span class="o">(</span><span class="n">withDefaults</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><p><br /></p><p>변경 후 추상화 객체가 빠지고 @Bean을 추가하고 함수 명이 바뀌고 리턴값이 생긴걸 볼 수 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfiguration</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SecurityFilterChain</span> <span class="nf">filterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeHttpRequests</span><span class="o">((</span><span class="n">authz</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">authz</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
            <span class="o">)</span>
            <span class="o">.</span><span class="na">httpBasic</span><span class="o">(</span><span class="n">withDefaults</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><p><br /><br /><br /></p><h3 id="oauthservice"><span class="mr-2">OAuthService</span><a href="#oauthservice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>SecurityConfig에서 OAuth2로그인 성공시에 OAuthService에서 처리를 한다.</p><p>그런데 code는 잘 받아오는데 OAuthService로 가지 않는 상황이 생겼다.</p><p>로그를 찍어봐도 애초에 OAuthService로 가지 않는 문제가 발생했다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">http</span><span class="o">.</span><span class="na">oauth2Login</span><span class="o">()</span> <span class="c1">// OAuth2 로그인 설정 시작점</span>
    <span class="o">.</span><span class="na">userInfoEndpoint</span><span class="o">()</span> <span class="c1">// OAuth2 로그인 성공 이후 사용자 정보를 가져올 때 설정 담당</span>
    <span class="o">.</span><span class="na">userService</span><span class="o">(</span><span class="n">oAuth2UserService</span><span class="o">)</span> <span class="c1">// OAuth2 로그인 성공 시, 후작업을 진행할 UserService 인터페이스 구현체 등록</span>
    <span class="o">.</span><span class="na">and</span><span class="o">()</span>
    <span class="o">.</span><span class="na">successHandler</span><span class="o">(</span><span class="n">successHandler</span><span class="o">)</span>
    <span class="o">.</span><span class="na">failureHandler</span><span class="o">(</span><span class="n">failureHandler</span><span class="o">);</span>
    <span class="o">.</span><span class="na">authorizationEndpoint</span><span class="o">().</span><span class="na">baseUri</span><span class="o">(</span><span class="s">"/oauth2/authorize"</span><span class="o">)</span> <span class="c1">// 소셜 로그인 Url</span>
      <span class="o">.</span><span class="na">and</span><span class="o">()</span>         
    <span class="o">.</span><span class="na">redirectionEndpoint</span><span class="o">().</span><span class="na">baseUri</span><span class="o">(</span><span class="s">"/oauth2/callback/**"</span><span class="o">);</span><span class="c1">// 소셜 인증 후 Redirect Url</span>
</pre></table></code></div></div><p>baseUri 같은 경우에는 successHandler에서 처리해주기 때문에 생략했다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">http</span><span class="o">.</span><span class="na">oauth2Login</span><span class="o">()</span>
    <span class="o">.</span><span class="na">userInfoEndpoint</span><span class="o">().</span><span class="na">userService</span><span class="o">(</span><span class="n">customOAuth2UserService</span><span class="o">)</span>
    <span class="o">.</span><span class="na">and</span><span class="o">()</span>
    <span class="o">.</span><span class="na">successHandler</span><span class="o">(</span><span class="n">successHandler</span><span class="o">)</span>
    <span class="o">.</span><span class="na">failureHandler</span><span class="o">(</span><span class="n">failureHandler</span><span class="o">)</span>
    <span class="o">.</span><span class="na">userInfoEndpoint</span><span class="o">().</span><span class="na">userService</span><span class="o">(</span><span class="n">customOAuth2UserService</span><span class="o">);</span>
</pre></table></code></div></div><p><br /><br /><br /></p><h3 id="redirection"><span class="mr-2">redirection</span><a href="#redirection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>카카오 로그인을 하면 “리디렉션한 횟수가 너무 많습니다.” 라는 오류가 뜨면서 계속 reload 되었다.</p><p>리디렉션 에러는 session 문제였다.</p><p>security에 <code class="language-plaintext highlighter-rouge">.sessionCreationPolicy(SessionCreationPolicy.STATELESS);</code> 를 작성했었는데</p><p>위 코드는 세션을 사용하지 않는다를 의미한다. 이부분을 제거하니 제대로 동작하였다.</p><p><br /><br /></p><p><strong>1.</strong> 클라이언트가 OAuth2 서비스 제공자에게 인증 요청을 보낸다.</p><p><strong>2.</strong> 사용자는 서비스 제공자에게 로그인 정보를 제공하고, 인증을 수행한다.</p><p><strong>3.</strong> 서비스 제공자는 클라이언트에게 인증 코드 또는 Access Token을 발급한다.</p><p><strong>4.</strong> 클라이언트는 발급 받은 인증 코드 또는 Access Token을 사용하여 서비스 제공자의 API에 요청을 보낸다.</p><p><strong>5.</strong> 서비스 제공자는 인증 코드 또는 Access Token의 유효성을 검증하고, 인증 및 자원 접근을 허용한다.</p><p><br /></p><p>OAuth2 로그인 과정에서 session을 사용하여 인증 정보를 저장하고 관리한다.</p><p>session은 server에서 상태를 유지하고 client는 sessionID를 통해 인증을 유지한다.</p><p>따라서 OAuth2를 사용하는 경우 session 기반의 인증방식을 활용해서 로그인을 처리한다.</p><p><br /></p><p>RESTful API와 같은 stateless한 시스템을 구축하려면 다른 토큰 기반의 인증 방식을 고려해야한다.</p><p><br /><br /><br /><br /></p><p><em>reference</em> <br /> <a href="https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api">Kakao developers REST API docs</a> <br /> <a href="https://jeeu147.tistory.com/145">[JAVA] Spring Boot(스프링 부트) - Security(시큐리티) 설정</a> <br /> <a href="https://imbf.github.io/spring/2020/06/29/Spring-Security-with-JWT.html">Spring Security + JWT를 통해 프로젝트에 인증 구현하기</a> <br /> <a href="https://sol-devlog.tistory.com/20">발급받은 JWT로 요청하기</a> <br /> <a href="https://velog.io/@jkijki12/Spring-Boot-OAuth2-JWT-%EC%A0%81%EC%9A%A9%ED%95%B4%EB%B3%B4%EB%A6%AC%EA%B8%B0">[Spring Boot] OAuth2 + JWT + React 적용해보리기</a> <br /> <a href="https://velog.io/@tmdgh0221/Spring-Security-%EC%99%80-OAuth-2.0-%EC%99%80-JWT-%EC%9D%98-%EC%BD%9C%EB%9D%BC%EB%B3%B4">Spring Security 와 OAuth 2.0 와 JWT 의 콜라보</a> <br /> <a href="https://kimchanjung.github.io/programming/2020/07/02/spring-security-02/">Spring Security 커스텀 필터를 이용한 인증 구현 - 스프링시큐리티 설정(2)</a> <br /> <a href="https://velog.io/@kurikuri/Spring-Security-OAuth-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0">Spring Security OAuth 설정 및 이해하기</a> <br /> <a href="https://jyami.tistory.com/121">Spring Security OAuth2 Login Flow</a> <br /> <a href="https://programmer93.tistory.com/78">Spring Security - UsernamePasswordAuthenticationFilter 란</a> <br /> <a href="https://jiurinie.tistory.com/73">[Spring Boot] Spring Security (5) - 역할(hasRole)과 권한(hasAuthority)의 차이는 무엇일까?</a> <br /> <a href="https://codediary21.tistory.com/73">(Spring Security) OAuth2 서비스 구현 정리</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/project/'>Project</a>, <a href='/categories/oauth2/'>OAuth2</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a> <a href="/tags/security/" class="post-tag no-text-decoration" >Security</a> <a href="/tags/oauth2/" class="post-tag no-text-decoration" >OAuth2</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Oauth2+%EC%A0%81%EC%9A%A9+-+Dal+Blog&url=https%3A%2F%2Fhaedal-uni.github.io%2F%2Fposts%2FOAuth2-%25EC%25A0%2581%25EC%259A%25A9%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Oauth2+%EC%A0%81%EC%9A%A9+-+Dal+Blog&u=https%3A%2F%2Fhaedal-uni.github.io%2F%2Fposts%2FOAuth2-%25EC%25A0%2581%25EC%259A%25A9%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fhaedal-uni.github.io%2F%2Fposts%2FOAuth2-%25EC%25A0%2581%25EC%259A%25A9%2F&text=Oauth2+%EC%A0%81%EC%9A%A9+-+Dal+Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div><script src="https://utteranc.es/client.js" repo="haedal-uni/comments" issue-term="title" label="comments" theme="github-light" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/%ED%86%B5%ED%95%A9-%ED%8C%8C%EC%9D%BC-%EC%9E%91%EC%84%B1%ED%95%98%EA%B8%B0/">통합 파일 작성하기</a><li><a href="/posts/Excel_%EC%9E%90%EB%8F%99%ED%99%94/">Excel_자동화</a><li><a href="/posts/%EB%8B%A8%EC%B6%95%ED%82%A4/">단축키</a><li><a href="/posts/%EA%B4%91%EA%B3%A0-%EB%8D%B0%EC%9D%B4%ED%84%B0/">광고 데이터</a><li><a href="/posts/Google-Analytics/">Google analytics</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/study/">study</a> <a class="post-tag" href="/tags/summary/">summary</a> <a class="post-tag" href="/tags/chat/">Chat</a> <a class="post-tag" href="/tags/log/">log</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/project/">project</a> <a class="post-tag" href="/tags/websocket/">WebSocket</a> <a class="post-tag" href="/tags/data-structure/">Data-Structure</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/OAuth2/"><div class="card-body"> <em class="small" data-ts="1677942000" data-df="ll" > Mar 5, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Oauth2</h3><div class="text-muted small"><p> OAuth 애플리케이션 인증을 위한 접근 관한 개방형 표준 프로토콜 인증 : 사용자가 누구인지 확인하는 단계 ex) login 권한 : 사용자가 해당 리소스에 접근할 권리가 있는지를 확인 Open Authorization의 약자로 인터넷 사용자들이 비밀번호를 제공하지 않고, 다른 웹사이트 상의 자신들의 정보에 대해 웹사이트나 애플리...</p></div></div></a></div><div class="card"> <a href="/posts/WebSocket-+-JWT/"><div class="card-body"> <em class="small" data-ts="1678460400" data-df="ll" > Mar 11, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Websocket + jwt</h3><div class="text-muted small"><p> WebSocket + JWT 관련 글 Websocket Websocket + 부가기능 Websocket (채팅 기록 json 파일 저장하기) Sse Sse 문제점 Websocket + jwt 👈🏻 Websocket test Jmh - 채팅 파일 refactoring 내가 채팅방을 작성하면서 security를 구현한...</p></div></div></a></div><div class="card"> <a href="/posts/WebSocket-+-Stomp-+-%EB%B3%B4%EC%95%88-%EA%B0%95%ED%99%94/"><div class="card-body"> <em class="small" data-ts="1685804400" data-df="ll" > Jun 4, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Websocket + stomp + 보안 강화</h3><div class="text-muted small"><p> WebSocket + Stomp + 보안 강화하기 WebSocket과 STOMP를 사용하여 실시간 통신을 구현하는 경우, 사용자 인증을 강화하여 보안성을 높이는 것이 중요하다. 이를 위해 JWT(Json Web Token) 토큰을 사용하여 사용자 인증을 처리하는 방법을 작성했다. JWT(Json Web Token) 토큰 JWT(Json Web...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/OAuth2/" class="btn btn-outline-primary" prompt="Older"><p>Oauth2</p></a> <a href="/posts/WebSocket-+-JWT/" class="btn btn-outline-primary" prompt="Newer"><p>Websocket + jwt</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/haedal-uni">haedal-uni</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/study/">study</a> <a class="post-tag" href="/tags/summary/">summary</a> <a class="post-tag" href="/tags/chat/">Chat</a> <a class="post-tag" href="/tags/log/">log</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/project/">project</a> <a class="post-tag" href="/tags/websocket/">WebSocket</a> <a class="post-tag" href="/tags/data-structure/">Data-Structure</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-K7KC8XYH0P"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-K7KC8XYH0P'); }); </script>
